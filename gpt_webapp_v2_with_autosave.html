<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë‚˜ë§Œì˜ GPT ë¹„ì„œ</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }
    #chat { white-space: pre-line; margin-top: 20px; }
    .entry { margin-bottom: 16px; }
    .user { font-weight: bold; color: #444; }
    .bot { margin-left: 10px; color: #0077cc; }
    textarea { width: 100%; height: 60px; margin-top: 10px; }
    button { margin-top: 10px; margin-right: 10px; }
    #top-bar { margin-bottom: 10px; }
  </style>
</head>
<body>

  <div id="app">
    <!-- API í‚¤ ì…ë ¥ í™”ë©´ -->
    <div id="keyInputScreen">
      <h3>API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”</h3>
      <input type="password" id="apiKeyInput" placeholder="sk-..." style="width:100%; padding:5px;">
      <button onclick="startChat()">ì‹œì‘í•˜ê¸°</button>
    </div>

    <!-- ì±„íŒ… í™”ë©´ -->
    <div id="chatScreen" style="display:none;">
      <div id="top-bar">
        <button onclick="exportLogs()">ë‚´ë³´ë‚´ê¸°</button>
        <button onclick="clearLogs()">ë¡œê·¸ ì´ˆê¸°í™”</button>
      </div>

      <div id="chat"></div>
      <textarea id="userInput" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
      <button onclick="sendMessage()">ë³´ë‚´ê¸°</button>
    </div>
  </div>

  <script>
    let apiKey = "";
    let logEntries = [];

    // ìë™ ë³µì›
    window.onload = function () {
      const saved = localStorage.getItem("chat_logs");
      if (saved && confirm("ì´ì „ì— ì €ì¥ëœ ëŒ€í™”ë¥¼ ë¶ˆëŸ¬ì˜¬ê¹Œìš”?")) {
        logEntries = JSON.parse(saved);
        renderLog();
      }
    };

    function startChat() {
      const inputKey = document.getElementById("apiKeyInput").value.trim();
      if (!inputKey.startsWith("sk-")) {
        alert("ìœ íš¨í•œ OpenAI API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      apiKey = inputKey;
      document.getElementById("keyInputScreen").style.display = "none";
      document.getElementById("chatScreen").style.display = "block";
    }

    function sendMessage() {
      const input = document.getElementById("userInput").value.trim();
      if (!input) return;

      const chatDiv = document.getElementById("chat");
      chatDiv.innerHTML += `<div class="entry"><span class="user">ğŸ‘¤ ë‚˜:</span> ${input}</div>`;
      document.getElementById("userInput").value = "";

      const timestamp = new Date().toISOString();
      const importance = getImportance(input);
      const type = getType(input);

      fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: "gpt-3.5-turbo",
          messages: [
            { role: "system", content: "ë„ˆëŠ” ì‚¬ìš©ìì˜ ë¹„ì„œì•¼. ê°„ê²°í•˜ê³  ìœ ìš©í•˜ê²Œ ë‹µë³€í•´." },
            { role: "user", content: input }
          ]
        })
      })
      .then(res => res.json())
      .then(data => {
        const reply = data.choices?.[0]?.message?.content?.trim() || "(ì‘ë‹µ ì—†ìŒ)";
        chatDiv.innerHTML += `<div class="entry"><span class="bot">ğŸ¤– GPT:</span> ${reply}</div>`;
        chatDiv.scrollTop = chatDiv.scrollHeight;

        const log = {
          timestamp: timestamp,
          user_input: input,
          ai_response: reply,
          importance: importance,
          type: type,
          feedback: "unrated"
        };

        logEntries.push(log);
        localStorage.setItem("chat_logs", JSON.stringify(logEntries));
      })
      .catch(err => {
        chatDiv.innerHTML += `<div class="entry"><span class="bot">ğŸ¤– GPT:</span> ì˜¤ë¥˜ ë°œìƒ: ${err.message}</div>`;
      });
    }

    function getImportance(input) {
      if (/(ì§€ê¸ˆ|ë¹¨ë¦¬|ê¸´ê¸‰|ì¦‰ì‹œ)/.test(input)) return "high";
      if (/(ë‚˜ì¤‘ì—|ì–¸ì  ê°€|ì—¬ìœ )/.test(input)) return "low";
      return "medium";
    }

    function getType(input) {
      if (/(íšŒì˜|ì¼ì •|ì•½ì†|ìŠ¤ì¼€ì¤„)/.test(input)) return "ì¼ì •";
      if (/(ê¸°ë¶„|ìš°ìš¸|í–‰ë³µ|ì§œì¦|ê°ì •)/.test(input)) return "ê°ì •";
      if (/(í•  ì¼|ì‘ì—…|ê³µë¶€|í•´ì•¼ í• |ì—…ë¬´)/.test(input)) return "ì‘ì—…";
      return "ê¸°íƒ€";
    }

    function exportLogs() {
      const blob = new Blob([JSON.stringify(logEntries, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "chat_log.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    function clearLogs() {
      if (confirm("ì •ë§ ë¡œê·¸ë¥¼ ëª¨ë‘ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        logEntries = [];
        localStorage.removeItem("chat_logs");
        document.getElementById("chat").innerHTML = "";
      }
    }

    function renderLog() {
      const chatDiv = document.getElementById("chat");
      chatDiv.innerHTML = "";
      logEntries.forEach(entry => {
        chatDiv.innerHTML += `
          <div class="entry"><span class="user">ğŸ‘¤ ë‚˜:</span> ${entry.user_input}</div>
          <div class="entry"><span class="bot">ğŸ¤– GPT:</span> ${entry.ai_response}</div>
        `;
      });
    }
  </script>
</body>
</html>
